# GitLab AI代码审查系统流程图

## 系统架构概览

```mermaid
graph TB
    subgraph "GitLab"
        A[开发者提交MR] --> B[GitLab触发Webhook]
    end
  
    subgraph "AI CR服务"
        B --> C[Webhook接收器]
        C --> D[事件处理器]
        D --> E[AI代码审查器]
        D --> F[GitLab API客户端]
    end
  
    subgraph "AI服务"
        E --> G[AI API调用]
    end
  
    subgraph "结果处理"
        F --> H[发布行内评论]
        F --> I[发布总体评论]
    end
```

## 详细流程图

### 1. Webhook接收与路由

```mermaid
flowchart TD
    A[GitLab Webhook事件] --> B{事件类型检查}
    B -->|merge_request| C[MR事件处理器]
    B -->|push| D[Push事件处理器]
    B -->|其他| E[返回不支持]
  
    C --> F[验证MR状态]
    F -->|opened/reopen/update| G[继续处理]
    F -->|其他| H[跳过处理]
  
    G --> I[检查MR大小限制]
    I -->|超出限制| J[记录警告并跳过]
    I -->|在限制内| K[启动异步审查任务]
```

### 2. MR大小限制检查

```mermaid
flowchart TD
    A[开始大小检查] --> B[获取MR变更]
    B --> C{是否有变更?}
    C -->|否| D[返回无变更]
    C -->|是| E[计算文件数量]
  
    E --> F[解析diff内容]
    F --> G[统计新增/删除行数]
    G --> H{检查限制}
  
    H -->|文件数>25| I[超出文件限制]
    H -->|行数>5000| J[超出行数限制]
    H -->|都在限制内| K[允许处理]
  
    I --> L[记录警告]
    J --> L
    K --> M[继续审查流程]
```

### 3. 异步代码审查任务

```mermaid
flowchart TD
    A[启动异步任务] --> B[生成任务ID]
    B --> C[记录任务状态]
    C --> D[异步执行审查]
  
    D --> E[获取MR变更]
    E --> F[获取已有评论]
    F --> G[AI代码审查]
    G --> H[发布行内评论]
  
    H --> I[更新任务状态]
    I --> J[清理已完成任务]
  
    D -->|失败| K[记录错误状态]
    K --> J
```

### 4. AI代码审查核心流程

```mermaid
flowchart TD
    A[开始AI审查] --> B[预处理变更]
    B --> C[过滤重要变更]
    C --> D[并发处理文件]
  
    D --> E[单个文件处理]
    E --> F[解析diff内容]
    F --> G[过滤代码行]
    G --> H[代码行分组]
  
    H --> I[AI审查代码组]
    I --> J[生成审查意见]
    J --> K[过滤有意义评论]
  
    K --> L[返回审查结果]
```

### 5. 代码行处理详细流程

```mermaid
flowchart TD
    A[解析diff] --> B[提取变更行]
    B --> C[过滤代码行]
  
    C --> D{长度检查}
    D -->|太短| E[跳过]
    D -->|太长| F[需要审查]
    D -->|适中| G[继续检查]
  
    G --> H{跳过模式检查}
    H -->|匹配跳过模式| I[跳过]
    H -->|不匹配| J[保留审查]
  
    J --> K[代码行分组]
    K --> L[连续行归组]
    L --> M[生成代码组]
```

### 6. AI审查提示词生成

```mermaid
flowchart TD
    A[代码组信息] --> B[生成审查提示]
    B --> C[添加代码质量规则]
    C --> D[添加安全规则]
    D --> E[添加性能规则]
    E --> F[设置输出格式]
  
    F --> G[调用AI API]
    G --> H[解析AI响应]
  
    H --> I{响应内容检查}
    I -->|PASS| J[跳过评论]
    I -->|有建议| K[生成评论]
    I -->|内容过长| L[截断处理]
```

### 7. 评论发布流程

```mermaid
flowchart TD
    A[审查结果] --> B[解析评论到文件]
    B --> C[按文件分组评论]
    C --> D[检查SHA信息]
  
    D --> E{SHA信息完整?}
    E -->|否| F[跳过该文件]
    E -->|是| G[准备行内评论]
  
    G --> H[构建评论位置]
    H --> I[调用GitLab API]
    I --> J[发布行内评论]
  
    J --> K{发布成功?}
    K -->|是| L[继续下一个]
    K -->|否| M[记录错误]
  
    L --> N[添加延迟]
    N --> O[检查是否完成]
    O -->|否| G
    O -->|是| P[完成发布]
```

### 8. 错误处理与重试机制

```mermaid
flowchart TD
    A[操作执行] --> B{是否成功?}
    B -->|是| C[继续流程]
    B -->|否| D[错误分类]
  
    D --> E{网络错误?}
    E -->|是| F[等待重试]
    E -->|否| G{API错误?}
  
    G -->|是| H[检查响应状态]
    G -->|否| I[其他错误]
  
    H --> J{状态码检查}
    J -->|4xx| K[客户端错误]
    J -->|5xx| L[服务器错误]
    J -->|其他| M[未知错误]
  
    F --> N[延迟重试]
    N --> O{重试次数}
    O -->|未超限| A
    O -->|超限| P[记录失败]
```

### 9. 任务状态管理

```mermaid
flowchart TD
    A[任务创建] --> B[状态: processing]
    B --> C{执行结果}
  
    C -->|成功| D[状态: completed]
    C -->|失败| E[状态: failed]
    C -->|超时| F[状态: timeout]
  
    D --> G[记录完成时间]
    E --> H[记录错误信息]
    F --> I[记录超时原因]
  
    G --> J[清理任务]
    H --> J
    I --> J
  
    J --> K{任务数量检查}
    K -->|超过100| L[删除旧任务]
    K -->|未超过| M[保持现状]
```

### 10. 系统监控与日志

```mermaid
flowchart TD
    A[系统操作] --> B[记录操作日志]
    B --> C[性能计时]
    C --> D[错误记录]
  
    D --> E{错误级别}
    E -->|ERROR| F[记录详细错误]
    E -->|WARN| G[记录警告信息]
    E -->|INFO| H[记录一般信息]
  
    F --> I[错误上下文]
    G --> J[警告上下文]
    H --> K[操作上下文]
  
    I --> L[错误统计]
    J --> L
    K --> L
  
    L --> M[性能分析]
    M --> N[系统健康检查]
```

## 关键配置参数


| 参数                   | 默认值 | 说明               |
| ---------------------- | ------ | ------------------ |
| `MAX_FILES_CONCURRENT` | 5      | 并发处理文件数     |
| `MAX_GROUPS_PER_BATCH` | 15     | 每批处理代码组数   |
| `MAX_LINES_PER_GROUP`  | 40     | 每组最大代码行数   |
| `AI_REQUEST_TIMEOUT`   | 6000ms | AI API请求超时     |
| `MAX_CONCURRENT_AI`    | 3      | 并发AI请求数       |
| `MR_MAX_FILES`         | 25     | MR最大文件数限制   |
| `MR_MAX_LINES`         | 5000   | MR最大代码行数限制 |

## 性能优化策略

1. **异步处理**: 所有代码审查任务异步执行，不阻塞webhook响应
2. **并发控制**: 限制并发文件处理和AI请求数量，避免资源耗尽
3. **批量处理**: 将代码组批量发送给AI，减少API调用次数
4. **智能过滤**: 预过滤明显不需要审查的代码，减少AI调用
5. **缓存机制**: 缓存审查结果，避免重复审查相同代码
6. **任务管理**: 自动清理已完成任务，维护系统性能

## 安全考虑

1. **输入验证**: 验证所有webhook事件和API参数
2. **权限控制**: 使用GitLab Bot Token进行API访问
3. **敏感信息**: 避免在日志中记录敏感信息
4. **错误处理**: 不暴露内部错误信息给外部
5. **超时控制**: 设置合理的API超时时间，防止资源耗尽

这个流程图详细展示了GitLab AI代码审查系统的完整工作流程，从webhook接收到评论发布的每个环节都有清晰的说明。
